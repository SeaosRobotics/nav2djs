var NAV2D=NAV2D||{REVISION:"0.6.0"};NAV2D.resizeMap=function(a,b,c){return a||(a={width:c.width,height:c.height,x:c.pose.position.x,y:c.pose.position.y},b.scaleToDimensions(c.width,c.height),b.shift(c.pose.position.x,c.pose.position.y)),(a.width!==c.width||a.height!==c.height)&&(b.scaleToDimensions(c.width,c.height),a.width=c.width,a.height=c.height),(a.x!==c.pose.position.x||a.y!==c.pose.position.y)&&(b.shift((c.pose.position.x-a.x)/1,(c.pose.position.y-a.y)/1),a.x=c.pose.position.x,a.y=c.pose.position.y),a},NAV2D.ImageMapClientNav=function(a){a=a||{};var b=a.ros,c=a.tfClient||null,d=a.topic||"/map_metadata",e=a.robot_pose||"/robot_pose",f=a.image_map,g=a.image||!1,h=a.serverName||"/move_base",i=a.actionName||"move_base_msgs/MoveBaseAction",j=a.rootObject||new createjs.Container,k=a.viewer,l=a.withOrientation||!1,m=null,n=new ROS2D.ImageMapClient({ros:b,rootObject:j,topic:d,image:f});new NAV2D.Navigator({ros:b,tfClient:c,serverName:h,actionName:i,robot_pose:e,rootObject:j,withOrientation:l,image:g});n.on("change",function(){m=NAV2D.resizeMap(m,k,n.currentGrid)})},NAV2D.Navigator=function(a){function b(a){if(null!==m){var b=new ROSLIB.Goal({actionClient:m,goalMessage:{target_pose:{header:{frame_id:"/map"},pose:a}}});b.send(),c.currentGoal=b,null===c.goalMarker&&(k&&ROS2D.hasOwnProperty("NavigationImage")?c.goalMarker=new ROS2D.NavigationImage({size:2.5,image:k,alpha:.7,pulse:!0}):c.goalMarker=new ROS2D.NavigationArrow({size:15,strokeSize:1,fillColor:createjs.Graphics.getRGB(255,64,128,.66),pulse:!0}),c.rootObject.addChild(c.goalMarker)),c.goalMarker.x=a.position.x,c.goalMarker.y=-a.position.y,c.goalMarker.rotation=n.rosQuaternionToGlobalTheta(a.orientation),c.goalMarker.scaleX=1/n.scaleX,c.goalMarker.scaleY=1/n.scaleY,b.on("result",function(){c.rootObject.removeChild(c.goalMarker)})}}var c=this;a=a||{};var d=a.ros||null,e=a.tfClient||null,f=a.robotClient||null,g=a.robot_pose||"/robot_pose",h=a.serverName||"/move_base",i=a.actionName||"move_base_msgs/MoveBaseAction",j=a.withOrientation||!1,k=a.image,l=a.fillColor||null;this.rootObject=a.rootObject||new createjs.Container,this.goalMarker=null;var m=null;null!==d&&(m=new ROSLIB.ActionClient({ros:d,actionName:i,serverName:h})),this.cancelGoal=function(){"undefined"!=typeof c.currentGoal&&c.currentGoal.cancel()};var n;n=c.rootObject instanceof createjs.Stage?c.rootObject:c.rootObject.getStage();var o=null;if(k&&ROS2D.hasOwnProperty("NavigationImage"))o=new ROS2D.NavigationImage({size:2.5,scaleX:1/n.scaleX,scaleY:1/n.scaleY,image:k,pulse:!0});else{var p;p=null!==l?l:createjs.Graphics.getRGB(255,128,0,.66),o=new ROS2D.NavigationArrow({size:25,strokeSize:1,fillColor:p,pulse:!0})}o.visible=!1,this.rootObject.addChild(o);var q=!1,r=function(a,b){o.x=a.x,o.y=-a.y,q||(o.scaleX=1/n.scaleX,o.scaleY=1/n.scaleY,q=!0),o.rotation=n.rosQuaternionToGlobalTheta(b),o.visible=!0};if(null!==e)e.subscribe(g,function(a){r(a.translation,a.rotation)});else if(null!==f)f.on("pose-update",function(a){r(a.position,a.orientation)});else{var s=new ROSLIB.Topic({ros:d,name:g,messageType:"geometry_msgs/Pose",throttle_rate:100});s.subscribe(function(a){r(a.position,a.orientation)})}if(j===!1)this.rootObject.addEventListener("dblclick",function(a){var c=n.globalToRos(a.stageX,a.stageY),d=new ROSLIB.Pose({position:new ROSLIB.Vector3(c)});b(d)});else{var t=null,u=null,v=0,w=0,x=null,y=!1,z=0,A=0,B=function(a,d){if("down"===d)t=n.globalToRos(a.stageX,a.stageY),u=new ROSLIB.Vector3(t),y=!0;else if("move"===d){if(c.rootObject.removeChild(x),y===!0){var e=n.globalToRos(a.stageX,a.stageY),f=new ROSLIB.Vector3(e);x=k&&ROS2D.hasOwnProperty("ImageNavigator")?new ROS2D.ImageNavigator({size:2.5,image:k,alpha:.7,pulse:!1}):new ROS2D.NavigationArrow({size:25,strokeSize:1,fillColor:createjs.Graphics.getRGB(0,255,0,.66),pulse:!1}),z=f.x-u.x,A=f.y-u.y,v=Math.atan2(z,A),w=v*(180/Math.PI),w>=0&&180>=w?w+=270:w-=90,x.x=u.x,x.y=-u.y,x.rotation=w,x.scaleX=1/n.scaleX,x.scaleY=1/n.scaleY,c.rootObject.addChild(x)}}else if(y){y=!1;var g=n.globalToRos(a.stageX,a.stageY),h=new ROSLIB.Vector3(g);z=h.x-u.x,A=h.y-u.y,v=Math.atan2(z,A),v>=0&&v<=Math.PI?v+=3*Math.PI/2:v-=Math.PI/2;var i=Math.sin(-v/2),j=Math.cos(-v/2),l=new ROSLIB.Quaternion({x:0,y:0,z:i,w:j}),m=new ROSLIB.Pose({position:u,orientation:l});b(m)}};this.rootObject.addEventListener("stagemousedown",function(a){B(a,"down")}),this.rootObject.addEventListener("stagemousemove",function(a){B(a,"move")}),this.rootObject.addEventListener("stagemouseup",function(a){B(a,"up")})}},NAV2D.OccupancyGridClientNav=function(a){a=a||{};var b=a.ros||null,c=a.tfClient||null,d=a.robotClient||null,e=a.topic||"/map",f=a.robot_pose||"/robot_pose",g=a.continuous,h=a.serverName||"/move_base",i=a.actionName||"move_base_msgs/MoveBaseAction",j=a.rootObject||new createjs.Container,k=a.viewer,l=a.withOrientation||!1,m=a.image||!1,n=null,o=a.gridClient||null,p=a.fillColor||null;null===o&&(o=new ROS2D.OccupancyGridClient({ros:b,rootObject:j,continuous:g,topic:e}));new NAV2D.Navigator({ros:b,tfClient:c,robotClient:d,serverName:h,actionName:i,robot_pose:f,rootObject:j,withOrientation:l,image:m,fillColor:p});o.on("change",function(){n=NAV2D.resizeMap(n,k,o.currentGrid)})},NAV2D.OccupancyGridMarker=function(a){var b=this;a=a||{};var c=a.ros||null,d=a.tfClient||null,e=a.robotClient||null,f=a.topic||"/map",g=a.robot_pose||"/robot_pose",h=a.rootObject||new createjs.Container,i=a.image||!1,j=a.useTriangle||!1,k=a.gridClient||null,l=a.fillColor||null,m=a.size||null,n=a.strokeSize||null,o=a.strokeColor||null,p=a.baseType||"circle",q=void 0===a.useHeading?!0:!1,r=a.continuous,s=a.viewer,t=null;null===k&&(k=new ROS2D.OccupancyGridClient({ros:c,rootObject:h,continuous:r,topic:f})),b.visualizator=new NAV2D.Visualizator({ros:c,tfClient:d,robotClient:e,robot_pose:g,rootObject:h,image:i,size:m,strokeSize:n,strokeColor:o,fillColor:l,baseType:p,useTriangle:j,useHeading:q}),k.on("change",function(){t=NAV2D.resizeMap(t,s,k.currentGrid)})},NAV2D.Visualizator=function(a){var b=this;a=a||{};var c=a.ros||null,d=a.tfClient||null,e=a.robotClient||null,f=a.robot_pose||"/robot_pose",g=a.size||null,h=a.strokeSize||1,i=a.strokeColor||null,j=a.fillColor||null;b.rootObject=a.rootObject||new createjs.Container;var k,l=a.baseType||"circle",m=a.useTriangle||!1,n=void 0===a.useHeading?!0:!1,o=a.image;k=b.rootObject instanceof createjs.Stage?b.rootObject:b.rootObject.getStage();var p,q=null;o&&ROS2D.hasOwnProperty("NavigationImage")?q=new ROS2D.NavigationImage({size:g||2.5,scaleX:1/k.scaleX,scaleY:1/k.scaleY,image:o,pulse:!1}):m?(p=null!==j?j:createjs.Graphics.getRGB(255,128,0,.66),q=new ROS2D.NavigationArrow({size:g||10,strokeSize:h||3,strokeColor:i,fillColor:p,pulse:!1})):(p=null!==j?j:createjs.Graphics.getRGB(255,128,0,.66),q=new ROS2D.NavigationShape({size:g||25,scaleX:1/k.scaleX,scaleY:1/k.scaleY,strokeSize:h,strokeColor:i,fillColor:p,pulse:!1,baseType:l,useHeading:n})),q.visible=!1,this.rootObject.addChild(q);var r=!1;b.poseUpdate=function(a){s(a.position,a.orientation)};var s=function(a,b){q.x=a.x,q.y=-a.y,r||(q.scaleX=1/k.scaleX,q.scaleY=1/k.scaleY,r=!0),q.rotation=k.rosQuaternionToGlobalTheta(b),q.visible=!0};if(null!==d)d.subscribe(f,function(a){s(a.translation,a.rotation)});else if(null!==e)e.on("pose-update",function(a){s(a.position,a.orientation)});else{var t=new ROSLIB.Topic({ros:c,name:f,messageType:"geometry_msgs/Pose",throttle_rate:100});t.subscribe(function(a){s(a.position,a.orientation)})}b.pulse=function(a){q.pulse(a)},b.pulsing=function(){return q.pulsing()},b.visible=function(){return q.visible},b.update=function(a){q.update(a)},b.hide=function(){q.visible=!1},q.addEventListener("mousedown",function(a){b.emit("mousedown",a)})},NAV2D.Visualizator.prototype.__proto__=EventEmitter2.prototype,global.NAV2D=NAV2D;